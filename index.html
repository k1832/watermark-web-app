<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画像透かし入れアプリ</title>
    <link rel="icon" href="favicon.ico" sizes="any">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #2563eb; /* blue-600 */
            border-radius: 50%;
            cursor: pointer;
            margin-top: -6px;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #2563eb;
            border-radius: 50%;
            cursor: pointer;
        }
    </style>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8KYEBVC6J4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-8KYEBVC6J4', { 'anonymize_ip': true });
    </script>

</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="container mx-auto max-w-lg bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col my-4">

        <!-- Control Panel -->
        <div class="w-full bg-gray-50 p-6 space-y-6">
            <h1 class="text-2xl font-bold text-gray-800 text-center">透かし設定</h1>

            <!-- Preview -->
            <div class="w-full bg-gray-200 flex justify-center items-center p-4 min-h-[300px] rounded-lg">
                <canvas id="previewCanvas" class="max-w-full max-h-[50vh] object-contain rounded-lg shadow-inner bg-gray-300" style="display: none;"></canvas>
            </div>


            <div>
                <label for="imageLoader" class="block text-sm font-medium text-gray-700 mb-2">1. 画像を選択</label>
                <input type="file" id="imageLoader" accept="image/*" class="w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-blue-50 file:text-blue-700
                    hover:file:bg-blue-100
                "/>
            </div>

            <div>
                <label for="watermarkText" class="block text-sm font-medium text-gray-700 mb-2">2. 透かし文字</label>
                <input type="text" id="watermarkText" value="@k1832_" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div>
                <label for="watermarkColor" class="block text-sm font-medium text-gray-700 mb-2">3. 文字色</label>
                <div class="flex items-center space-x-2">
                    <input type="color" id="watermarkColor" value="#FFFFFF" class="w-12 h-10 p-1 border border-gray-300 rounded-lg cursor-pointer">
                    <input type="text" id="colorHexValue" value="#FFFFFF" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>

            <div>
                <label for="watermarkOpacity" class="block text-sm font-medium text-gray-700 mb-2">4. 不透明度</label>
                <div class="flex items-center space-x-3">
                    <input type="range" id="watermarkOpacity" min="0" max="1" step="0.01" value="0.5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span id="opacityValue" class="font-medium text-gray-700 text-sm w-12 text-right">50%</span>
                </div>
            </div>

            <div>
                <label for="fontSize" class="block text-sm font-medium text-gray-700 mb-2">5. 文字サイズ</label>
                <div class="flex items-center space-x-3">
                    <input type="range" id="fontSize" min="8" max="128" step="1" value="32" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span id="fontSizeValue" class="font-medium text-gray-700 text-sm w-12 text-right">32px</span>
                </div>
            </div>

            <div>
                <label for="watermarkSpacing" class="block text-sm font-medium text-gray-700 mb-2">6. 間隔 (密度)</label>
                <div class="flex items-center space-x-3">
                    <input type="range" id="watermarkSpacing" min="1" max="10" step="0.5" value="4" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span id="spacingValue" class="font-medium text-gray-700 text-sm w-12 text-right">4.0</span>
                </div>
            </div>

            <div class="bg-green-50 border-l-4 border-green-500 text-green-700 p-4 rounded-lg flex items-start">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-500 mr-3 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                </svg>
                <div>
                    <p class="font-bold">処理はすべてデバイス上で完結</p>
                    <p class="text-sm">アップロードされた画像がサーバーに送信されることは一切ありません。すべての処理はあなたのブラウザ内で行われます。</p>
                </div>
            </div>

            <div>
                <button id="downloadButton" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                    画像をダウンロード
                </button>
            </div>
        </div>

        <div class="w-full bg-white p-4 border-t border-gray-100">
            <a href="https://x.com/k1832_" target="_blank" rel="noopener noreferrer" class="flex items-center justify-center text-gray-500 hover:text-gray-800 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-4 h-4 mr-2" viewBox="0 0 16 16">
                  <path d="M12.6.75h2.454l-5.36 6.142L16 15.25h-4.937l-3.867-5.07-4.425 5.07H.316l5.733-6.57L0 .75h5.063l3.495 4.633L12.601.75Zm-.86 13.028h1.36L4.323 2.145H2.865l8.875 11.633Z"></path>
                </svg>
                <span class="text-sm font-medium">Created by @k1832_</span>
            </a>
        </div>

    </div>

    <script>
        const imageLoader = document.getElementById('imageLoader');
        const watermarkText = document.getElementById('watermarkText');
        const watermarkColor = document.getElementById('watermarkColor');
        const colorHexValue = document.getElementById('colorHexValue');
        const watermarkOpacity = document.getElementById('watermarkOpacity');
        const opacityValue = document.getElementById('opacityValue');
        const fontSize = document.getElementById('fontSize');
        const fontSizeValue = document.getElementById('fontSizeValue');
        const watermarkSpacing = document.getElementById('watermarkSpacing');
        const spacingValue = document.getElementById('spacingValue');
        const downloadButton = document.getElementById('downloadButton');
        const canvas = document.getElementById('previewCanvas');
        const ctx = canvas.getContext('2d');

        /**
         * Helper function to send Google Analytics events
         * @param {string} eventName - The name of the event (e.g., 'image_upload')
         * @param {object} [eventParams] - Optional parameters for the event
         */
        function trackEvent(eventName, eventParams = {}) {
            if (typeof gtag === 'function') {
                gtag('event', eventName, eventParams);
            } else {
                console.log(`GA Event (gtag not found): ${eventName}`, eventParams);
            }
        }

        // State Management
        let originalImage = new Image();
        let currentWatermark = {
            text: '@k1832_',
            color: '#FFFFFF',
            opacity: 0.5,
            fontSize: 32,
            spacing: 4
        };

        // Initial Setup (Disable download button)
        downloadButton.disabled = true;

        imageLoader.addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = event => {

                originalImage.onload = () => {
                    canvas.width = originalImage.width;
                    canvas.height = originalImage.height;
                    redrawCanvas();
                    canvas.style.display = 'block';
                    downloadButton.disabled = false;

                    trackEvent('image_upload', {});
                }
                originalImage.src = event.target.result;
            }
            reader.readAsDataURL(file);
        });

        watermarkText.addEventListener('input', e => {
            currentWatermark.text = e.target.value;
            redrawCanvas();
        });

        watermarkColor.addEventListener('input', e => {
            currentWatermark.color = e.target.value;
            colorHexValue.value = e.target.value; // Update hex text input as well
            redrawCanvas();
        });

        colorHexValue.addEventListener('input', e => {
            currentWatermark.color = e.target.value;
            watermarkColor.value = e.target.value; // Update color picker as well
            redrawCanvas();
        });

        watermarkOpacity.addEventListener('input', e => {
            currentWatermark.opacity = parseFloat(e.target.value);
            opacityValue.textContent = `${Math.round(currentWatermark.opacity * 100)}%`;
            redrawCanvas();
        });

        fontSize.addEventListener('input', e => {
            currentWatermark.fontSize = parseInt(e.target.value, 10);
            fontSizeValue.textContent = `${currentWatermark.fontSize}px`;
            redrawCanvas();
        });

        watermarkSpacing.addEventListener('input', e => {
            currentWatermark.spacing = parseFloat(e.target.value);
            spacingValue.textContent = currentWatermark.spacing.toFixed(1);
            redrawCanvas();
        });

        downloadButton.addEventListener('click', () => {
            redrawCanvas();

            trackEvent('image_download', {});

            try {
                canvas.toBlob(function(blob) {
                    if (!blob) {
                        console.error('Canvas toBlob failed');
                        return;
                    }
                    const url = URL.createObjectURL(blob);

                    const link = document.createElement('a');
                    link.download = 'watermarked-image.png';
                    link.href = url;

                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    URL.revokeObjectURL(url);

                }, 'image/png');
            } catch (e) {
                console.error('Download failed:', e);
            }
        });


        /**
         * Convert hex color to rgba string
         * @param {string} hex - #RRGGBB format
         * @param {number} opacity - 0.0 ~ 1.0
         * @returns {string} - "rgba(r, g, b, opacity)" format
         */
        function hexToRgba(hex, opacity) {
            let r = 0, g = 0, b = 0;
            // 3 digits (#RGB)
            if (hex.length === 4) {
                r = parseInt(hex[1] + hex[1], 16);
                g = parseInt(hex[2] + hex[2], 16);
                b = parseInt(hex[3] + hex[3], 16);
            }
            // 6 digits (#RRGGBB)
            else if (hex.length === 7) {
                r = parseInt(hex[1] + hex[2], 16);
                g = parseInt(hex[3] + hex[4], 16);
                b = parseInt(hex[5] + hex[6], 16);
            }
            return `rgba(${r}, ${g}, ${b}, ${opacity})`;
        }

        function redrawCanvas() {
            if (!originalImage.src || !originalImage.complete) {
                return;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);

            if (!currentWatermark.text) {
                return;
            }

            ctx.save(); // Save the current state
            ctx.font = `bold ${currentWatermark.fontSize}px Inter`;
            ctx.fillStyle = hexToRgba(currentWatermark.color, currentWatermark.opacity);
            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';

            const angleInDegrees = -30;
            ctx.rotate(angleInDegrees * Math.PI / 180);

            const textMetrics = ctx.measureText(currentWatermark.text);
            const textWidth = textMetrics.width;

            const spacingFactor = currentWatermark.spacing;
            const stepX = textWidth + currentWatermark.fontSize * spacingFactor;
            const stepY = currentWatermark.fontSize * spacingFactor * 0.75; // 0.75 is an approximate line height factor

            const diagonal = Math.sqrt(canvas.width * canvas.width + canvas.height * canvas.height);

            for (let x = -diagonal; x < diagonal * 2; x += stepX) {
                for (let y = -diagonal; y < diagonal * 2; y += stepY) {
                    ctx.fillText(currentWatermark.text, x, y);
                }
            }

            ctx.restore(); // Restore the original state
        }

    </script>
</body>
</html>
